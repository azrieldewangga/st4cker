# WhatsApp Gateway Migration Plan: Baileys to Puppeteer

## ⚠️ Problem Context
The current implementation using `@whiskeysockets/baileys` (a lightweight, reverse-engineered WS library) is failing with persistent **HTTP 405 (Method Not Allowed)** errors during the handshake.
- **Cause:** WhatsApp's servers have likely flagged the connection signature from the VPS IP address as a "bot" or unauthorized client.
- **Impact:** We cannot establish a stable connection even after clearing auth state and using pairing codes.
- **Solution:** Switch to **`whatsapp-web.js`**, which wraps **Puppeteer (Headless Chrome)**. This runs a *real* browser instance, making the connection indistinguishable from a standard WhatsApp Web session.

## Proposed Architecture Logic
- **Library:** `whatsapp-web.js` + `puppeteer`
- **Browser:** Google Chrome Stable (installed in Docker)
- **Container:** Needs to be heavier (~400MB+) to support Chrome, but stability > size.
- **Auth:** Session data stored in `docker volume` (`st4cker_wa_auth`) similar to before.

## Implementation Steps

### 1. Rebuild `wa-gateway` Container
We will completely replace the internal logic of the `wa-gateway` folder.

#### `package.json`
- Remove: `@whiskeysockets/baileys`
- Add: `whatsapp-web.js`, `express`, `qrcode-terminal`

#### `Dockerfile`
- Base Image: `node:18-slim` (Alpine is hard for Chrome)
- **Crucial:** Install `google-chrome-stable` and fonts via `apt-get`.
- Env Vars: `PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true`, `PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable`.

#### `index.js` (The Code)
- Initialize `Client` with `LocalAuth` (persists to `/app/auth_state`).
- **QR Code:** Generated by the library's `qr` event.
- **API:** Resposes `POST /send`.
- **Arguments:** Need `--no-sandbox` and `--disable-gpu` for Docker stability.

### 2. Deployment on VPS
The deployment steps remain similar, but the build time will be longer (installing Chrome).

```bash
# 1. Update Code & Pull
git pull

# 2. Rebuild (takes 2-5 mins)
docker compose down wa-gateway
docker volume rm st4cker_wa_auth  # START FRESH
docker compose up -d --build wa-gateway

# 3. Scan QR
docker logs -f wa-gateway
# QR code will appear in logs
```

## Pros & Cons
| Feature | Baileys (Current) | Puppeteer (Proposed) |
| :--- | :--- | :--- |
| **Stability** | Low (prone to 405/ban) | **High** (Real Browser) |
| **Resource Usage** | Low (<50MB RAM) | **High** (~300-500MB RAM) |
| **Speed** | Fast | Slower startup |
| **Auth** | Multi-device complex | **Simple** (LocalAuth) |

## Verification
1. **API Health:** `GET http://wa-gateway:4000/health`
2. **Send Message:** `POST http://wa-gateway:4000/send { "to": "628...", "message": "test" }`
3. **Log Check:** Ensure "Client is ready!" appears in logs.
